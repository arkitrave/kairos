/*! kairos v0.0.1 2013-03-06 */
(function(t,e){function i(t,e,i){return t+e-(i?(t+e)%(!0===i?e:i):0)}function s(){if(this.isStarted()&&!this.isEnded()){var t,n=[this._data,this._relatedTime-(new Date).getTime()||0];this._parent.publish("frameTicked",n),this._name&&this._parent.publish("frameTicked/"+this._name,n),this._tickInterval&&(t=(new Date).getTime(),this._tickTimeout=setTimeout(e.bind(s,this),i(t,this._tickInterval,this._syncTicks)-t))}}function n(){if(!this.isEnded()){this._ended=!0,clearTimeout(this._tickTimeout);var t=[this._data,this._relatedTime-(new Date).getTime()||0];this._parent.logger.info("Ending Frame",this._name),this._parent.publish("frameEnded",t),this._name&&this._parent.publish("frameEnded/"+this._name,t)}}function r(){if(!this.isStarted()){this._started=!0;var t=[this._data,this._relatedTime-(new Date).getTime()||0];this._parent.logger.info("Starting Frame",this._name),this._parent.publish("frameStarted",t),this._name&&this._parent.publish("frameStarted/"+this._name,t),this._tickInterval&&s.call(this),1/0!==this._endsAt&&setTimeout(e.bind(n,this),this._endsAt-(new Date).getTime())}}function a(t,e){this._parent=t,this._name=e.frameName,this._beginsAt=e.begin,this._endsAt=e.end,this._tickInterval=e.interval,this._syncTicks=e.sync,this._relatedTime=e.relatedTo,this._data=e.data,this._paused=!1,this._started=!1,this._ended=!1,this._tickInterval?this._parent.logger.info("Kairos Frame created that will tick every "+this._tickInterval+"ms from "+this._beginsAt+" until "+this._endsAt):this._parent.logger.info("Kairos Frame created that begins at "+this._beginsAt+" and ends at "+this._endsAt)}e.extend(a.prototype,{start:function(){var t=(new Date).getTime();t>=this._beginsAt?r.call(this):setTimeout(e.bind(r,this),this._beginsAt-t)},pause:function(){clearTimeout(this._tickTimeout),this._paused=!0},resume:function(){this.isPaused()&&(this._paused=!1,this.isStarted()&&!this.isEnded()&&s.call(this))},isStarted:function(){return this._started},isEnded:function(){return this._ended},isPaused:function(){return this._paused},toJSON:function(){return{name:this._name,begins_at:this._beginsAt,ends_at:this.endsAt,tick_interval:this.tickInterval,sync_ticks:this.syncTicks,related_time:this.relatedTime,data:this._data}}}),t.KairosFrame=a})("object"==typeof exports&&exports||this,this._||this.require&&require("underscore")),function(t,e,i){function s(t){return e.reduce(e.map(t.match(c).splice(1),function(t,e){return parseInt(t,10)*d[e]||0}),function(t,e){return t+e},0)}function n(t,i,s){t[i]&&(e.isString(t[i])?t[i]=s[t[i]]:e.isDate(t[i])&&(t[i]=t[i].getTime()))}function r(t,i,r){var a=r;return e.isNumber(t)?a=t:(n(t,"at",i),n(t,"after",i),n(t,"before",i),n(t,"between",i),n(t,"and",i),e.isString(t.interpolated)&&(t.interpolated=parseFloat(t.interpolated)/100),e.isString(t.starting)&&(t.starting=s(t.starting)),e.isNumber(t.at)?a=t.at:e.isNumber(t.starting)?e.isNumber(t.before)?a=t.before-t.starting:e.isNumber(t.after)&&(a=t.after+t.starting):e.isNumber(t.interpolated)&&e.isNumber(t.between)&&e.isNumber(t.and)&&(a=t.between+(t.and-t.between)*t.interpolated)),a}function a(t){e.each(t.times,function(i,s){e.isDate(i)&&(t.times[s]=i.getTime())}),e.each(t.frames,function(i){e.defaults(i,{sync:!0,begin:{},end:{}}),n(i,"relatedTo",t.times),e.isString(i.interval)&&(i.interval=s(i.interval)),i.begin=r(i.begin,t.times,0)}),e.each(t.frames,function(e,i){var s=t.frames[i+1],n=s?s.begin:1/0;e.begin>n&&(n=1/0),e.end=r(e.end,t.times,n)})}function h(t){t=e.extend({times:{},frames:[],autoStart:!0},t);var s=this;a(t),this._options=t,this._frames=e.map(t.frames,function(t){return new i(s,t)}),this.logger.info("Kairos Scheduler created with options",JSON.stringify(t)),t.autoStart&&this.start()}var o=this,u=function(t){return function(e,i){if(o.console&&console[t])if(i=[].splice.call(arguments,1),0===i.length)console[t](e);else try{console[t].apply(null,[].splice.call(arguments,0))}catch(s){console[t](e,i)}}},d=[31536e6,2592e6,864e5,36e5,6e4,1e3],c=RegExp("^\\s*P?\\s*(?:(\\d+)Y)?\\s*(?:(\\d+)M)?\\s*(?:(\\d+)D)?\\s*T?\\s*(?:(\\d+)H)?\\s*(?:(\\d+)M)?\\s*(?:(\\d+)S)?$","i");e.extend(h.prototype,{start:function(){e.invoke(this._frames,"start")},pause:function(){e.invoke(this._frames,"pause")},resume:function(){e.invoke(this._frames,"resume")},publish:function(t,i,s){var n=this;n._notifyChannels&&n._notifyChannels[t]&&(e.isArray(i)||(i=[i]),e.each(n._notifyChannels[t],function(t){try{t.apply(s,i)}catch(e){n.logger.error(e)}}))},subscribe:function(t,e){this._notifyChannels||(this._notifyChannels={}),this._notifyChannels[t]||(this._notifyChannels[t]=[]),this._notifyChannels[t].push(e)},logger:{log:u("log"),info:u("info"),debug:u("debug"),warn:u("warn"),error:u("error")}}),t.KairosScheduler=h}("object"==typeof exports&&exports||this,this._||this.require&&require("underscore"),this.KairosFrame||"object"==typeof exports&&exports.KairosFrame);