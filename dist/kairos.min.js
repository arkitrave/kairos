/*! kairos v0.0.1 2013-03-11 */
(function(t,e){function i(t,e,i){return t+e-(i?(t+e)%(!0===i?e:i):0)}function s(){if(this.isStarted()&&!this.isEnded()){var t,n=[this._relatedTime-(new Date).getTime()||0,this._data];this._parent.publish("frameTicked",n),this._name&&this._parent.publish(this._name+"/ticked",n),this._tickInterval&&(t=(new Date).getTime(),this._tickTimeout=setTimeout(e.bind(s,this),i(t,this._tickInterval,this._syncTicks)-t))}}function n(){if(!this.isEnded()){this._ended=!0,clearTimeout(this._tickTimeout);var t=[this._relatedTime-(new Date).getTime()||0,this._data];this._parent.logger.info("Ending Frame",this._name),this._parent.publish("frameEnded",t),this._name&&this._parent.publish(this._name+"/ended",t)}}function r(){if(!this.isStarted()){this._started=!0;var t=[this._relatedTime-(new Date).getTime()||0,this._data];this._parent.logger.info("Starting Frame",this._name),this._parent.publish("frameStarted",t),this._name&&this._parent.publish(this._name+"/started",t),this._tickInterval&&s.call(this),1/0!==this._endsAt&&setTimeout(e.bind(n,this),this._endsAt-(new Date).getTime())}}function a(t,e){this._parent=t,this._name=e.name,this._beginsAt=e.begin,this._endsAt=e.end,this._tickInterval=e.interval,this._syncTicks=e.sync,this._relatedTime=e.relatedTo,this._data=e.data,this._paused=!1,this._started=!1,this._ended=!1,this._tickInterval?this._parent.logger.info("Kairos Frame created that will tick every "+this._tickInterval+"ms from "+this._beginsAt+" until "+this._endsAt):this._parent.logger.info("Kairos Frame created that begins at "+this._beginsAt+" and ends at "+this._endsAt)}e.extend(a.prototype,{start:function(){var t=(new Date).getTime();t>=this._endsAt?this._ended=!0:t>=this._beginsAt?r.call(this):setTimeout(e.bind(r,this),this._beginsAt-t)},pause:function(){clearTimeout(this._tickTimeout),this._paused=!0},resume:function(){this.isPaused()&&(this._paused=!1,this.isStarted()&&!this.isEnded()&&s.call(this))},isStarted:function(){return this._started},isEnded:function(){return this._ended},isPaused:function(){return this._paused},toJSON:function(){return{name:this._name,begins_at:this._beginsAt,ends_at:this.endsAt,tick_interval:this.tickInterval,sync_ticks:this.syncTicks,related_time:this.relatedTime,data:this._data}}}),t.KairosFrame=a})("object"==typeof exports&&exports||this,this._||"object"==typeof exports&&require("underscore")),function(t,e,i){function s(t){var i=t.match(m);return i?i=i.splice(1):(i=[0,0,0,0,0,0,0],e.find(l,function(s){return t.match(s)?(t.replace(s,function(t,s){var n;e.find(e.rest(arguments,2),function(t,e){return n=e,!!t}),i[n]=parseInt(s,10)}),!0):!1})),e.reduce(e.map(i,function(t,e){return parseInt(t,10)*f[e]||0}),function(t,e){return t+e},0)}function n(t,i,s){t[i]&&(e.isString(t[i])?t[i]=s[t[i]]:e.isDate(t[i])&&(t[i]=t[i].getTime()))}function r(t,i,r){var a=r;return e.isNumber(t)?a=t:e.isDate(t)||e.isString(t)&&(a=i[t],e.find(u,function(e){var i=t.match(e.regex);if(i)switch(e.mode){case"interpolated":t={interpolated:/%/.test(i[1])?i[1]:parseFloat(i[1]),between:i[2],and:i[3]};break;case"after":t={starting:i[1],after:i[2]};break;case"before":t={starting:i[1],before:i[2]};break;case"at":t={at:i[1]}}return!!i})),n(t,"at",i),n(t,"after",i),n(t,"before",i),n(t,"between",i),n(t,"and",i),e.isString(t.interpolated)&&(t.interpolated=parseFloat(t.interpolated)/100),e.isString(t.starting)&&(t.starting=s(t.starting)),e.isNumber(t.at)?a=t.at:e.isNumber(t.starting)?e.isNumber(t.before)?a=t.before-t.starting:e.isNumber(t.after)&&(a=t.after+t.starting):e.isNumber(t.interpolated)&&e.isNumber(t.between)&&e.isNumber(t.and)&&(a=t.between+(t.and-t.between)*t.interpolated),a}function a(t,i){e.defaults(t,{sync:!0,begin:{},end:{}}),n(t,"relatedTo",i),e.isString(t.interval)&&(t.interval=s(t.interval)),t.begin=r(t.begin,i,0)}function o(t){e.each(t.times,function(i,s){e.isDate(i)&&(t.times[s]=i.getTime())}),e.each(t.frames,function(e){a(e,t.times)}),e.each(t.frames,function(e,i){var s=t.frames[i+1],n=s?s.begin:1/0;e.begin>n&&(n=1/0),e.end=r(e.end,t.times,n)})}function h(t){t=e.extend({times:{},frames:[],autoStart:!0},t);var s=this;o(t),this._options=t,this._frames=e.map(t.frames,function(t){return new i(s,t)}),this.logger.info("Kairos Scheduler created with options",JSON.stringify(t)),this._isStarted=!1,t.autoStart&&this.start()}var d=this,c=function(t){return function(e,i){if(d.console&&console[t])if(i=[].splice.call(arguments,1),0===i.length)console[t](e);else try{console[t].apply(null,[].splice.call(arguments,0))}catch(s){console[t](e,i)}}},u=[{mode:"interpolated",regex:/(?:(?:interpolated)\s+)?(.*)\s+(?:between|from)\s+(.*)\s+(?:and|to)\s+(.*)/},{mode:"after",regex:/(?:(?:starting)\s+)?(.*)\s+(?:after|from|following)\s+(.*)/},{mode:"before",regex:/(?:(?:starting)\s+)?(.*)\s+(?:before|until|preceeding)\s+(.*)/},{mode:"at",regex:/(?:(?:at)\s+)?(.*)/}],f=[31536e6,2592e6,864e5,36e5,6e4,1e3,1],m=RegExp("^\\s*P?\\s*(?:(\\d+)Y)?\\s*(?:(\\d+)M)?\\s*(?:(\\d+)D)?\\s*T?\\s*(?:(\\d+)H)?\\s*(?:(\\d+)M)?\\s*(?:(\\d+)S)?$","i"),l=[/(\d+)\s*(y(?:ear)?s?)?(mon(?:th)?s?)?(d(?:ay)?s?)?(h(?:our)?s?)?(min(?:ute)?s?)?(s(?:econd)?s?)?/gi];e.extend(h.prototype,{start:function(){this._isStarted=!0,e.invoke(this._frames,"start")},pause:function(){e.invoke(this._frames,"pause")},resume:function(){e.invoke(this._frames,"resume")},addFrame:function(t){if(!t.name||!e.contains(e.pluck(this._options.frames,"name"),t.name)){a(t,this._options.times),t.end=r(t.end,this._options.times,1/0),this._options.frames.push(t);var s=new i(this,t);this._frames.push(s),this._isStarted&&s.start()}},publish:function(t,i,s){var n=this;n._notifyChannels&&n._notifyChannels[t]&&(e.isArray(i)||(i=[i]),e.each(n._notifyChannels[t],function(t){try{t.apply(s,i)}catch(e){n.logger.error(e)}}))},subscribe:function(t,e){this._notifyChannels||(this._notifyChannels={}),this._notifyChannels[t]||(this._notifyChannels[t]=[]),this._notifyChannels[t].push(e)},logger:{log:c("log"),info:c("info"),debug:c("debug"),warn:c("warn"),error:c("error")}}),t.KairosScheduler=h}("object"==typeof exports&&exports||this,this._||"object"==typeof exports&&require("underscore"),"object"==typeof exports&&exports.KairosFrame||this.KairosFrame);