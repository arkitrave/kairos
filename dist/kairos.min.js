/*! kairos v0.2.0 2013-03-28 */
(function(e,t,i){function n(t){return function(i,n){if(e.console&&console[t])if(n=[].splice.call(arguments,1),0===n.length)console[t](i);else try{console[t].apply(null,[].splice.call(arguments,0))}catch(s){console[t](i,n)}}}function s(e){if(t.isNumber(e))return e;if(t.isString(e)){if(""+parseFloat(e)===e)return parseFloat(e);var i=e.match(g);return i?i=i.splice(1):(i=[0,0,0,0,0,0,0],e.replace(p,function(e,n){var s=6;t.find(t.rest(arguments,2),function(e,t){return s=t,!!e}),i[s]=parseFloat(n)})),t.reduce(t.map(i,function(e,t){return parseInt(e,10)*m[t]||0}),function(e,t){return e+t},0)}return 0}function r(e,i){if(t.isNumber(e))return e;if(t.isDate(e))return e.getTime();if(t.isString(e)){if(""+parseFloat(e)===e)return parseFloat(e);if(!t.isUndefined(i[e]))return i[e];if(!isNaN(Date.parse(e)))return Date.parse(e);t.find(f,function(t){var i=e.match(t.regex);if(i)switch(t.mode){case"interpolated":e={interpolated:parseFloat(i[1])*(/%/.test(i[1])?.01:1),between:i[2],and:i[3]};break;case"after":e={starting:i[1],after:i[2]};break;case"before":e={starting:i[1],before:i[2]};break;case"at":e={at:i[1]}}return!!i})}if(t.isObject(e)){if(!t.isUndefined(e.at))return r(e.at,i);if(t.isUndefined(e.starting)){if(t.isNumber(e.interpolated)&&!t.isUndefined(e.between)&&!t.isUndefined(e.and))return r(e.between,i)+(r(e.and,i)-r(e.between,i))*e.interpolated}else{if(!t.isUndefined(e.after))return r(e.after,i)+s(e.starting);if(!t.isUndefined(e.before))return r(e.before,i)-s(e.starting)}}return 0}function a(){var e=this._private(i);e.normalizedBeginsAt=this.getBeginsAt(),e.normalizedEndsAt=this.getEndsAt(),e.normalizedTicksEvery=this.getTicksEvery(),e.normalizedRelativeTo=this.getRelativeTo(),e.normalizedSyncTo=this.getSyncTo(),e.normalizedNamedTimes=this.getNamedTimes()}function o(){var e=(new Date).getTime(),t=this.getTicksEvery(),i=this.getSyncTo();return e+t-(i?(e+t)%i:0)}function u(){var e=this._private(i);this.publish("ticked",this),e.tickTimeout=setTimeout(t.bind(u,this),o.call(this)-(new Date).getTime())}function d(){var e=this._private(i);e.isEnded=!0,clearTimeout(e.tickTimeout),this.logger.info("Ending KairosTimeFrame",this.toJson()),this.publish("ended",this)}function h(){var e=this._private(i);e.isBegun=!0,this.logger.info("Starting KairosTimeFrame",this.toJson()),this.publish("began",this),this.getTicksEvery()&&(e.tickTimeout=setTimeout(t.bind(u,this),o.call(this)-(new Date).getTime())),1/0!==this.getEndsAt()&&(e.endTimeout=setTimeout(t.bind(d,this),this.getEndsAt()-(new Date).getTime()))}function c(e,n){this.logger.info("Creating a new Kairos Time Frame");var s=t.extend({beginsAt:"epoch",endsAt:"never",relativeTo:"beginsAt",namedTimes:{},name:t.isString(e)?e:null},t.isObject(e)?e:n,{isStarted:!1,isStopped:!1,isMuted:!1,isBegun:!1,isEnded:!1,notifyChannels:{}});t.defaults(s.namedTimes,{epoch:0,now:(new Date).getTime(),never:1/0}),this._private=function(e){if(e===i)return s;throw"Access Denied"}}var l=["epoch","now","never"],m=[31536e6,2592e6,864e5,36e5,6e4,1e3,1],f=[{mode:"interpolated",regex:/(?:(?:interpolated)\s+)?(.*)\s+(?:between|from)\s+(.*)\s+(?:and|to)\s+(.*)/},{mode:"after",regex:/(?:(?:starting)\s+)?(.*)\s+(?:after|from|following)\s+(.*)/},{mode:"before",regex:/(?:(?:starting)\s+)?(.*)\s+(?:before|until|preceeding)\s+(.*)/},{mode:"at",regex:/at\s+(.*)/}],g=RegExp("^\\s*P?\\s*(?:(\\d+(?:[\\.,]\\d+)?)Y)?\\s*(?:(\\d+(?:[\\.,]\\d+)?)M)?\\s*(?:(\\d+(?:[\\.,]\\d+)?)D)?\\s*T?\\s*(?:(\\d+(?:[\\.,]\\d+)?)H)?\\s*(?:(\\d+(?:[\\.,]\\d+)?)M)?\\s*(?:(\\d+(?:[\\.,]\\d+)?)S)?$","i"),p=/(\d+(?:[\\.,]\\d+)?)\s*(y(?:ear)?s?)?(mon(?:th)?s?)?(d(?:ay)?s?)?(h(?:our)?s?)?(min(?:ute)?s?)?(s(?:econd)?s)?(m(?:illi)?s(?:econds?)?)?/gi;t.extend(c.prototype,{start:function(){if(!this.isStarted()&&!this.isStopped()){var e=this._private(i),n=(new Date).getTime();a.call(this),e.isStarted=!0,n>=this.getEndsAt()?e.isEnded=!0:n>=this.getBeginsAt()?h.call(this):e.startTimeout=setTimeout(t.bind(h,this),this.getBeginsAt()-(new Date).getTime())}return this},stop:function(){if(!this.isStopped()){var e=this._private(i);e.isStopped=!0,clearTimeout(e.startTimeout),clearTimeout(e.tickTimeout),clearTimeout(e.endTimeout)}return this},mute:function(){var e=this._private(i);return e.isMuted||(e.isMuted=!0,clearTimeout(e.tickTimeout),this.publish("muted",this)),this},unmute:function(){var e=this._private(i);return e.isMuted&&(e.isMuted=!1,this.getTicksEvery()&&e.isStarted&&!e.isStopped&&e.isBegun&&!e.isEnded&&(e.tickTimeout=setTimeout(t.bind(u,this),o.call(this)-(new Date).getTime())),this.publish("unmuted",this)),this},subscribe:function(e,t){var n=this._private(i).notifyChannels;return n[e]||(n[e]=[]),n[e].push(t),this},publish:function(e,n,s){var r=this,a=this._private(i).notifyChannels;return a[e]&&(t.isArray(n)||(n=[n]),t.each(a[e],function(e){try{e.apply(s,n)}catch(t){r.logger.error(t)}})),this},unsubscribe:function(e){var t,n=this._private(i).notifyChannels,s=e[0],r=e[1];if(n[s])for(t=0;n[s].length>t;t+=1)n[s][t]===r&&n[s].splice(t,1);return this},toJSON:function(){return{name:this.getName(),state:{is_started:this.isStarted(),is_stopped:this.isEnded(),is_begun:this.isBegun(),is_ended:this.isEnded(),is_muted:this.isMuted()},begins_at:this.getBeginsAt(),ends_at:this.getEndsAt(),ticks_every:this.getTicksEvery(),relative_to:this.getRelativeTo(),sync_to:this.getSyncTo(),named_times:this.getNamedTimes(),data:this.getData(),relative_duration:this.getRelativeDuration()}},toString:function(){return JSON.stringify(this.toJson(),null,2)},logger:{log:n("log"),info:n("info"),debug:n("debug"),warn:n("warn"),error:n("error")},isStarted:function(){return this._private(i).isStarted},isStopped:function(){return this._private(i).isStopped},isMuted:function(){return this._private(i).isMuted},isBegun:function(){return this._private(i).isBegun},isEnded:function(){return this._private(i).isEnded},getName:function(){return this._private(i).name},getBeginsAt:function(e){e=t.extend({originalValue:!1},e);var n,s=this._private(i);return e.originalValue?s.beginsAt:this.isStarted()?s.normalizedBeginsAt:(n=t.clone(s.namedTimes),t.each(s.namedTimes,function(e,t){n[t]=r(e,n)}),r(s.beginsAt,n))},setBeginsAt:function(e){if(!e)throw"No value provided";if(this.isStarted())throw"Immutable";return this._private(i).beginsAt=e,this},getEndsAt:function(e){e=t.extend({originalValue:!1},e);var n,s=this._private(i);return e.originalValue?s.endsAt:this.isStarted()?s.normalizedEndsAt:(n=t.clone(s.namedTimes),t.each(s.namedTimes,function(e,t){n[t]=r(e,n)}),n.beginsAt=r(s.beginsAt,n),r(s.endsAt,n))},setEndsAt:function(e){if(!e)throw"No value provided";if(this.isStarted())throw"Immutable";return this._private(i).endsAt=e,this},getTicksEvery:function(e){e=t.extend({originalValue:!1},e);var n=this._private(i);return e.originalValue?n.ticksEvery:this.isStarted()?n.normalizedTicksEvery:s(n.ticksEvery)},setTicksEvery:function(e){if(!e)throw"No value provided";if(this.isStarted())throw"Immutable";return this._private(i).ticksEvery=e,this},getRelativeTo:function(e){e=t.extend({originalValue:!1},e);var n,s=this._private(i);return e.originalValue?s.relativeTo:this.isStarted()?s.normalizedRelativeTo:(n=t.clone(s.namedTimes),t.each(s.namedTimes,function(e,t){n[t]=r(e,n)}),n.beginsAt=r(s.beginsAt,n),n.endsAt=r(s.endsAt,n),r(s.relativeTo,n))},setRelativeTo:function(e){if(!e)throw"No value provided";if(this.isStarted())throw"Immutable";return this._private(i).relativeTo=e,this},getSyncTo:function(e){e=t.extend({originalValue:!1},e);var n=this._private(i);return e.originalValue?n.syncTo:this.isStarted()?n.normalizedSyncTo:s(n.syncTo)},setSyncTo:function(e){if(!e)throw"No value provided";if(this.isStarted())throw"Immutable";return this._private(i).syncTo=e,this},getNamedTimes:function(e){e=t.extend({originalValue:!1,includeDefaults:!1},e);var n,s=this._private(i),a={};return e.originalValue?t.each(s.namedTimes,function(i,n){(e.includeDefaults||!t.contains(l,n))&&(a[n]=i)}):this.isStarted()?a=t.clone(s.normalizedNamedTimes):(n=t.extend({beginsAt:r(s.beginsAt,s.namedTimes)},s.namedTimes),n.endsAt=r(s.endsAt,n),t.each(s.namedTimes,function(i,s){(e.includeDefaults||!t.contains(l,s))&&(a[s]=r(i,n))})),a},extendNamedTimes:function(e){if(!e)throw"No value provided";if(this.isStarted())throw"Immutable";return t.extend(this._private(i).namedTimes,e),this},getData:function(){return this._private(i).data},setData:function(e){if(!e)throw"No value provided";if(this.isStarted())throw"Immutable";return this._private(i).data=e,this},getRelativeDuration:function(){return this.getRelativeTo()-(new Date).getTime()}}),c.prototype.toJson=c.prototype.toJSON,e.KairosTimeFrame=c})("object"==typeof exports&&exports||this,"object"==typeof exports&&require&&require("underscore")||this._||_,Math.floor(1e7*Math.random()+1e7).toString(36)),function(e,t,i,n){function s(t){return function(i,n){if(e.console&&console[t])if(n=[].splice.call(arguments,1),0===n.length)console[t](i);else try{console[t].apply(null,[].splice.call(arguments,0))}catch(s){console[t](i,n)}}}function r(e){var t=this;e.subscribe("began",function(e){t.publish("timeFrameBegan",[e]),e.getName()&&t.publish(e.getName()+"/began",[e])}),e.subscribe("ended",function(e){t.publish("timeFrameEnded",[e]),e.getName()&&t.publish(e.getName()+"/ended",[e])}),e.subscribe("ticked",function(e){t.publish("timeFrameTicked",[e]),e.getName()&&t.publish(e.getName()+"/ticked",[e])}),e.subscribe("muted",function(e){t.publish("timeFrameMuted",[e]),e.getName()&&t.publish(e.getName()+"/muted",[e])}),e.subscribe("unmuted",function(e){t.publish("timeFrameUnmuted",[e]),e.getName()&&t.publish(e.getName()+"/unmuted",[e])})}function a(e){this.logger.info("Creating a new Kairos Collection");var s={frames:t.map(e,function(e){return e instanceof i?e:new i(e)}),notifyChannels:{}},a=t.compact(t.invoke(s.frames,"getName"));if(a.length!==t.unique(a).length)throw"Duplicate Names";t.each(s.frames,t.bind(r,this)),this._private=function(e){if(e===n)return s;throw"Access Denied"}}t.extend(a.prototype,{start:function(){return t.invoke(this._private(n).frames,"start"),this},stop:function(){return t.invoke(this._private(n).frames,"stop"),this},mute:function(){return t.invoke(this._private(n).frames,"mute"),this},unmute:function(){return t.invoke(this._private(n).frames,"unmute"),this},subscribe:function(e,t){var i=this._private(n).notifyChannels;return i[e]||(i[e]=[]),i[e].push(t),this},publish:function(e,i,s){var r=this,a=this._private(n).notifyChannels;return a[e]&&(t.isArray(i)||(i=[i]),t.each(a[e],function(e){try{e.apply(s,i)}catch(t){r.logger.error(t)}})),this},unsubscribe:function(e){var t,i=this._private(n).notifyChannels,s=e[0],r=e[1];if(i[s])for(t=0;i[s].length>t;t+=1)i[s][t]===r&&i[s].splice(t,1);return this},toJSON:function(){return{}},toString:function(){return JSON.stringify(this.toJson(),null,2)},logger:{log:s("log"),info:s("info"),debug:s("debug"),warn:s("warn"),error:s("error")},pushTimeFrame:function(e){return e instanceof i||(e=new i(e)),this.logger.info("Adding new Time Frame",e),this._private(n).frames.push(e),r.call(this,e),this},extendNamedTimes:function(e){return t.invoke(this._private(n).frames,"extendNamedTimes",e),this},getTimeFrames:function(){return t.clone(this._private(n).frames)},getNamedTimeFrame:function(e){if(e)return t.find(this._private(n).frames,function(t){return t.getName()===e});throw"No Name Provided"}}),a.prototype.toJson=a.prototype.toJSON,e.KairosCollection=a}("object"==typeof exports&&exports||this,"object"==typeof exports&&require&&require("underscore")||this._||_,"object"==typeof exports&&exports.KairosTimeFrame||this.KairosTimeFrame,Math.floor(1e7*Math.random()+1e7).toString(36));