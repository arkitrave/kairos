/*! kairos v0.3.0 2013-04-01 */
(function(e){function t(e){this.name="AccessDenied",this.message=e||"Access is denied"}function i(e){this.name="DuplicateError",this.message=e||"Duplicate values found"}function n(e){this.name="ImmutableError",this.message=e||"This object is immutable"}function r(e){this.name="MissingParameter",this.message=e||"No value was provided"}t.prototype=Error(),t.prototype.constructor=t,e.AccessDenied=t,i.prototype=Error(),i.prototype.constructor=i,e.DuplicateError=i,n.prototype=Error(),n.prototype.constructor=n,e.ImmutableError=n,r.prototype=Error(),r.prototype.constructor=r,e.MissingParameter=r})("object"==typeof exports&&exports||this),function(e,t,i){function n(t){return function(i,n){if(e.console&&console[t])if(n=[].splice.call(arguments,1),0===n.length)console[t](i);else try{console[t].apply(null,[].splice.call(arguments,0))}catch(r){console[t](i,n)}}}function r(e){if(t.isNumber(e))return e;if(t.isString(e)){if(""+parseFloat(e)===e)return parseFloat(e);var i=e.match(g);return i?i=i.splice(1):(i=[0,0,0,0,0,0,0],e.replace(p,function(e,n){var r=6;t.find(t.rest(arguments,2),function(e,t){return r=t,!!e}),i[r]=parseFloat(n)})),t.reduce(t.map(i,function(e,t){return parseInt(e,10)*l[t]||0}),function(e,t){return e+t},0)}return 0}function s(e,i){if(t.isNumber(e))return e;if(t.isDate(e))return e.getTime();if(t.isString(e)){if(""+parseFloat(e)===e)return parseFloat(e);if(!t.isUndefined(i[e]))return i[e];if(!isNaN(Date.parse(e)))return Date.parse(e);t.find(f,function(t){var i=e.match(t.regex);if(i)switch(t.mode){case"interpolated":e={interpolated:parseFloat(i[1])*(/%/.test(i[1])?.01:1),between:i[2],and:i[3]};break;case"after":e={starting:i[1],after:i[2]};break;case"before":e={starting:i[1],before:i[2]};break;case"at":e={at:i[1]}}return!!i})}if(t.isObject(e)){if(!t.isUndefined(e.at))return s(e.at,i);if(t.isUndefined(e.starting)){if(t.isNumber(e.interpolated)&&!t.isUndefined(e.between)&&!t.isUndefined(e.and))return s(e.between,i)+(s(e.and,i)-s(e.between,i))*e.interpolated}else{if(!t.isUndefined(e.after))return s(e.after,i)+r(e.starting);if(!t.isUndefined(e.before))return s(e.before,i)-r(e.starting)}}return 0}function a(){var e=this._private(i);e.normalizedBeginsAt=this.getBeginsAt(),e.normalizedEndsAt=this.getEndsAt(),e.normalizedTicksEvery=this.getTicksEvery(),e.normalizedRelativeTo=this.getRelativeTo(),e.normalizedSyncsTo=this.getSyncsTo(),e.normalizedNamedTimes=this.getNamedTimes()}function o(){var e=(new Date).getTime(),t=this.getTicksEvery(),i=this.getSyncsTo();return e+t-(i?(e+t)%i:0)}function u(){var e=this._private(i);this.publish("ticked",this),e.tickTimeout=setTimeout(t.bind(u,this),o.call(this)-(new Date).getTime())}function c(){var e=this._private(i);e.isEnded=!0,clearTimeout(e.tickTimeout),this.logger.info("Ending KairosTimeFrame",this.toJson()),this.publish("ended",this)}function h(){var e=this._private(i);e.isBegun=!0,this.logger.info("Starting KairosTimeFrame",this.toJson()),this.publish("began",this),this.getTicksEvery()&&(e.tickTimeout=setTimeout(t.bind(u,this),o.call(this)-(new Date).getTime())),1/0!==this.getEndsAt()&&(e.endTimeout=setTimeout(t.bind(c,this),this.getEndsAt()-(new Date).getTime()))}function d(n,r){this.logger.info("Creating a new Kairos Time Frame");var s=t.extend({beginsAt:"epoch",endsAt:"never",relativeTo:"beginsAt",namedTimes:{},name:t.isString(n)?n:null},t.isObject(n)?n:r,{isStarted:!1,isStopped:!1,isMuted:!1,isBegun:!1,isEnded:!1,notifyChannels:{}});t.defaults(s.namedTimes,{epoch:0,now:(new Date).getTime(),never:1/0}),this._private=function(t){if(t===i)return s;throw new e.AccessDenied}}var m=["epoch","now","never"],l=[31536e6,2592e6,864e5,36e5,6e4,1e3,1],f=[{mode:"interpolated",regex:/(?:(?:interpolated)\s+)?(.*)\s+(?:between|from)\s+(.*)\s+(?:and|to)\s+(.*)/},{mode:"after",regex:/(?:(?:starting)\s+)?(.*)\s+(?:after|from|following)\s+(.*)/},{mode:"before",regex:/(?:(?:starting)\s+)?(.*)\s+(?:before|until|preceeding)\s+(.*)/},{mode:"at",regex:/at\s+(.*)/}],g=RegExp("^\\s*P?\\s*(?:(\\d+(?:[\\.,]\\d+)?)Y)?\\s*(?:(\\d+(?:[\\.,]\\d+)?)M)?\\s*(?:(\\d+(?:[\\.,]\\d+)?)D)?\\s*T?\\s*(?:(\\d+(?:[\\.,]\\d+)?)H)?\\s*(?:(\\d+(?:[\\.,]\\d+)?)M)?\\s*(?:(\\d+(?:[\\.,]\\d+)?)S)?$","i"),p=/(\d+(?:[\\.,]\\d+)?)\s*(y(?:ear)?s?)?(mon(?:th)?s?)?(d(?:ay)?s?)?(h(?:our)?s?)?(min(?:ute)?s?)?(s(?:econd)?s)?(m(?:illi)?s(?:econds?)?)?/gi;t.extend(d.prototype,{start:function(){if(!this.isStarted()&&!this.isStopped()){var e=this._private(i),n=(new Date).getTime();a.call(this),e.isStarted=!0,n>=this.getEndsAt()?e.isEnded=!0:n>=this.getBeginsAt()?h.call(this):e.startTimeout=setTimeout(t.bind(h,this),this.getBeginsAt()-(new Date).getTime())}return this},stop:function(){if(!this.isStopped()){var e=this._private(i);e.isStopped=!0,clearTimeout(e.startTimeout),clearTimeout(e.tickTimeout),clearTimeout(e.endTimeout)}return this},mute:function(){var e=this._private(i);return e.isMuted||(e.isMuted=!0,clearTimeout(e.tickTimeout),this.publish("muted",this)),this},unmute:function(){var e=this._private(i);return e.isMuted&&(e.isMuted=!1,this.getTicksEvery()&&e.isStarted&&!e.isStopped&&e.isBegun&&!e.isEnded&&(e.tickTimeout=setTimeout(t.bind(u,this),o.call(this)-(new Date).getTime())),this.publish("unmuted",this)),this},subscribe:function(e,t){var n=this._private(i).notifyChannels;return n[e]||(n[e]=[]),n[e].push(t),this},publish:function(e,n,r){var s=this,a=this._private(i).notifyChannels;return a[e]&&(t.isArray(n)||(n=[n]),t.each(a[e],function(e){try{e.apply(r,n)}catch(t){s.logger.error(t)}})),this},unsubscribe:function(e){var t,n=this._private(i).notifyChannels,r=e[0],s=e[1];if(n[r])for(t=0;n[r].length>t;t+=1)n[r][t]===s&&n[r].splice(t,1);return this},toJSON:function(){return{name:this.getName(),state:{is_started:this.isStarted(),is_stopped:this.isEnded(),is_begun:this.isBegun(),is_ended:this.isEnded(),is_muted:this.isMuted()},begins_at:this.getBeginsAt(),ends_at:this.getEndsAt(),ticks_every:this.getTicksEvery(),relative_to:this.getRelativeTo(),sync_to:this.getSyncsTo(),named_times:this.getNamedTimes(),data:this.getData(),relative_duration:this.getRelativeDuration()}},toString:function(){return JSON.stringify(this.toJson(),null,2)},logger:{log:n("log"),info:n("info"),debug:n("debug"),warn:n("warn"),error:n("error")},isStarted:function(){return this._private(i).isStarted},isStopped:function(){return this._private(i).isStopped},isMuted:function(){return this._private(i).isMuted},isBegun:function(){return this._private(i).isBegun},isEnded:function(){return this._private(i).isEnded},getName:function(){return this._private(i).name},getBeginsAt:function(e){e=t.extend({originalValue:!1},e);var n,r=this._private(i);return e.originalValue?r.beginsAt:this.isStarted()?r.normalizedBeginsAt:(n=t.clone(r.namedTimes),t.each(r.namedTimes,function(e,t){n[t]=s(e,n)}),s(r.beginsAt,n))},setBeginsAt:function(t){if(!t)throw new e.MissingParameter;if(this.isStarted())throw new e.ImmutableError;return this._private(i).beginsAt=t,this},getEndsAt:function(e){e=t.extend({originalValue:!1},e);var n,r=this._private(i);return e.originalValue?r.endsAt:this.isStarted()?r.normalizedEndsAt:(n=t.clone(r.namedTimes),t.each(r.namedTimes,function(e,t){n[t]=s(e,n)}),n.beginsAt=s(r.beginsAt,n),s(r.endsAt,n))},setEndsAt:function(t){if(!t)throw new e.MissingParameter;if(this.isStarted())throw new e.ImmutableError;return this._private(i).endsAt=t,this},getTicksEvery:function(e){e=t.extend({originalValue:!1},e);var n=this._private(i);return e.originalValue?n.ticksEvery:this.isStarted()?n.normalizedTicksEvery:r(n.ticksEvery)},setTicksEvery:function(t){if(!t)throw new e.MissingParameter;if(this.isStarted())throw new e.ImmutableError;return this._private(i).ticksEvery=t,this},getRelativeTo:function(e){e=t.extend({originalValue:!1},e);var n,r=this._private(i);return e.originalValue?r.relativeTo:this.isStarted()?r.normalizedRelativeTo:(n=t.clone(r.namedTimes),t.each(r.namedTimes,function(e,t){n[t]=s(e,n)}),n.beginsAt=s(r.beginsAt,n),n.endsAt=s(r.endsAt,n),s(r.relativeTo,n))},setRelativeTo:function(t){if(!t)throw new e.MissingParameter;if(this.isStarted())throw new e.ImmutableError;return this._private(i).relativeTo=t,this},getSyncsTo:function(e){e=t.extend({originalValue:!1},e);var n=this._private(i);return e.originalValue?n.syncsTo:this.isStarted()?n.normalizedSyncsTo:r(n.syncsTo)},setSyncsTo:function(t){if(!t)throw new e.MissingParameter;if(this.isStarted())throw new e.ImmutableError;return this._private(i).syncsTo=t,this},getNamedTimes:function(e){e=t.extend({originalValue:!1,includeDefaults:!1},e);var n,r=this._private(i),a={};return e.originalValue?t.each(r.namedTimes,function(i,n){(e.includeDefaults||!t.contains(m,n))&&(a[n]=i)}):this.isStarted()?a=t.clone(r.normalizedNamedTimes):(n=t.extend({beginsAt:s(r.beginsAt,r.namedTimes)},r.namedTimes),n.endsAt=s(r.endsAt,n),t.each(r.namedTimes,function(i,r){(e.includeDefaults||!t.contains(m,r))&&(a[r]=s(i,n))})),a},extendNamedTimes:function(n){if(!n)throw new e.MissingParameter;if(this.isStarted())throw new e.ImmutableError;return t.extend(this._private(i).namedTimes,n),this},getData:function(){return this._private(i).data},setData:function(t){if(!t)throw new e.MissingParameter;if(this.isStarted())throw new e.ImmutableError;return this._private(i).data=t,this},getRelativeDuration:function(){return this.getRelativeTo()-(new Date).getTime()},version:"0.3.0"}),d.prototype.toJson=d.prototype.toJSON,d.version="0.3.0",e.KairosTimeFrame=d}("object"==typeof exports&&exports||this,"object"==typeof exports&&require&&require("underscore")||this._||_,Math.floor(1e7*Math.random()+1e7).toString(36)),function(e,t,i,n){function r(t){return function(i,n){if(e.console&&console[t])if(n=[].splice.call(arguments,1),0===n.length)console[t](i);else try{console[t].apply(null,[].splice.call(arguments,0))}catch(r){console[t](i,n)}}}function s(e){var t=this;e.subscribe("began",function(e){t.publish("timeFrameBegan",[e]),e.getName()&&t.publish(e.getName()+"/began",[e])}),e.subscribe("ended",function(e){t.publish("timeFrameEnded",[e]),e.getName()&&t.publish(e.getName()+"/ended",[e])}),e.subscribe("ticked",function(e){t.publish("timeFrameTicked",[e]),e.getName()&&t.publish(e.getName()+"/ticked",[e])}),e.subscribe("muted",function(e){t.publish("timeFrameMuted",[e]),e.getName()&&t.publish(e.getName()+"/muted",[e])}),e.subscribe("unmuted",function(e){t.publish("timeFrameUnmuted",[e]),e.getName()&&t.publish(e.getName()+"/unmuted",[e])})}function a(r){this.logger.info("Creating a new Kairos Collection");var a={frames:t.map(r,function(e){return e instanceof i?e:new i(e)}),notifyChannels:{}},o=t.compact(t.invoke(a.frames,"getName"));if(o.length!==t.unique(o).length)throw new e.DuplicateError("Duplicate names found");t.each(a.frames,t.bind(s,this)),this._private=function(t){if(t===n)return a;throw new e.AccessDenied}}t.extend(a.prototype,{start:function(){return t.invoke(this._private(n).frames,"start"),this},stop:function(){return t.invoke(this._private(n).frames,"stop"),this},mute:function(){return t.invoke(this._private(n).frames,"mute"),this},unmute:function(){return t.invoke(this._private(n).frames,"unmute"),this},subscribe:function(e,t){var i=this._private(n).notifyChannels;return i[e]||(i[e]=[]),i[e].push(t),this},publish:function(e,i,r){var s=this,a=this._private(n).notifyChannels;return a[e]&&(t.isArray(i)||(i=[i]),t.each(a[e],function(e){try{e.apply(r,i)}catch(t){s.logger.error(t)}})),this},unsubscribe:function(e){var t,i=this._private(n).notifyChannels,r=e[0],s=e[1];if(i[r])for(t=0;i[r].length>t;t+=1)i[r][t]===s&&i[r].splice(t,1);return this},toJSON:function(){return{}},toString:function(){return JSON.stringify(this.toJson(),null,2)},logger:{log:r("log"),info:r("info"),debug:r("debug"),warn:r("warn"),error:r("error")},extendNamedTimes:function(e){return t.invoke(this._private(n).frames,"extendNamedTimes",e),this},pushTimeFrame:function(e){return e instanceof i||(e=new i(e)),this.logger.info("Adding new Time Frame",e),this._private(n).frames.push(e),s.call(this,e),this},getTimeFrames:function(){return t.clone(this._private(n).frames)},getNamedTimeFrame:function(i){if(i)return t.find(this._private(n).frames,function(e){return e.getName()===i});throw new e.MissingParameter("No name was provided")},version:"0.3.0"}),a.prototype.toJson=a.prototype.toJSON,a.version="0.3.0",e.KairosCollection=a}("object"==typeof exports&&exports||this,"object"==typeof exports&&require&&require("underscore")||this._||_,"object"==typeof exports&&exports.KairosTimeFrame||this.KairosTimeFrame,Math.floor(1e7*Math.random()+1e7).toString(36));