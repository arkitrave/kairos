/*! kairos v0.3.0 2013-04-08 */
(function(e){function t(){function e(e){this.name="AccessDenied",this.message=e||"Access is denied"}function t(e){this.name="DuplicateError",this.message=e||"Duplicate values found"}function i(e){this.name="ImmutableError",this.message=e||"This object is immutable"}function n(e){this.name="MissingParameter",this.message=e||"No value was provided"}var r={};return e.prototype=Error(),e.prototype.constructor=e,r.AccessDenied=e,t.prototype=Error(),t.prototype.constructor=t,r.DuplicateError=t,i.prototype=Error(),i.prototype.constructor=i,r.ImmutableError=i,n.prototype=Error(),n.prototype.constructor=n,r.MissingParameter=n,r}"function"==typeof define&&define.amd?define("kairos_errors",[],t):e.KairosErrors=t()})("object"==typeof exports&&exports||this),function(e,t){function i(e){return function(t,i){if(r.console&&console[e])if(i=[].splice.call(arguments,1),0===i.length)console[e](t);else try{console[e].apply(null,[].splice.call(arguments,0))}catch(n){console[e](t,i)}}}function n(e,n){function r(t){if(e.isNumber(t))return t;if(e.isString(t)){if(""+parseFloat(t)===t)return parseFloat(t);var i=t.match(g);return i?i=i.splice(1):(i=[0,0,0,0,0,0,0],t.replace(p,function(t,n){var r=6;e.find(e.rest(arguments,2),function(e,t){return r=t,!!e}),i[r]=parseFloat(n)})),e.reduce(e.map(i,function(e,t){return parseInt(e,10)*f[t]||0}),function(e,t){return e+t},0)}return 0}function s(t,i){if(e.isNumber(t))return t;if(e.isDate(t))return t.getTime();if(e.isString(t)){if(""+parseFloat(t)===t)return parseFloat(t);if(!e.isUndefined(i[t]))return i[t];if(!isNaN(Date.parse(t)))return Date.parse(t);e.find(l,function(e){var i=t.match(e.regex);if(i)switch(e.mode){case"interpolated":t={interpolated:parseFloat(i[1])*(/%/.test(i[1])?.01:1),between:i[2],and:i[3]};break;case"after":t={starting:i[1],after:i[2]};break;case"before":t={starting:i[1],before:i[2]};break;case"at":t={at:i[1]}}return!!i})}if(e.isObject(t)){if(!e.isUndefined(t.at))return s(t.at,i);if(e.isUndefined(t.starting)){if(e.isNumber(t.interpolated)&&!e.isUndefined(t.between)&&!e.isUndefined(t.and))return s(t.between,i)+(s(t.and,i)-s(t.between,i))*t.interpolated}else{if(!e.isUndefined(t.after))return s(t.after,i)+r(t.starting);if(!e.isUndefined(t.before))return s(t.before,i)-r(t.starting)}}return 0}function a(){var e=this._private(t);e.normalizedBeginsAt=this.getBeginsAt(),e.normalizedEndsAt=this.getEndsAt(),e.normalizedTicksEvery=this.getTicksEvery(),e.normalizedTicksRelativeTo=this.getTicksRelativeTo(),e.normalizedSyncsTo=this.getSyncsTo(),e.normalizedNamedTimes=this.getNamedTimes()}function o(){var e=(new Date).getTime(),t=this.getTicksEvery(),i=this.getSyncsTo();return e+t-(i?(e+t)%i:0)}function u(){var i=this._private(t);this.publish("ticked",this),i.tickTimeout=setTimeout(e.bind(u,this),o.call(this)-(new Date).getTime())}function c(){var e=this._private(t);e.isEnded=!0,clearTimeout(e.tickTimeout),this.logger.info("Ending KairosTimeFrame",this.toJson()),this.publish("ended",this)}function d(){var i=this._private(t);i.isBegun=!0,this.logger.info("Starting KairosTimeFrame",this.toJson()),this.publish("began",this),this.getTicksEvery()&&(i.tickTimeout=setTimeout(e.bind(u,this),o.call(this)-(new Date).getTime())),1/0!==this.getEndsAt()&&(i.endTimeout=setTimeout(e.bind(c,this),this.getEndsAt()-(new Date).getTime()))}function h(i,r){this.logger.info("Creating a new Kairos Time Frame");var s=e.extend({beginsAt:"epoch",endsAt:"never",ticksRelativeTo:"beginsAt",namedTimes:{},name:e.isString(i)?i:null},e.isObject(i)?i:r,{isStarted:!1,isStopped:!1,isMuted:!1,isBegun:!1,isEnded:!1,notifyChannels:{}});e.defaults(s.namedTimes,{epoch:0,now:(new Date).getTime(),never:1/0}),this._private=function(e){if(e===t)return s;throw new n.AccessDenied}}var m=["epoch","now","never"],f=[31536e6,2592e6,864e5,36e5,6e4,1e3,1],l=[{mode:"interpolated",regex:/(?:(?:interpolated)\s+)?(.*)\s+(?:between|from)\s+(.*)\s+(?:and|to)\s+(.*)/},{mode:"after",regex:/(?:(?:starting)\s+)?(.*)\s+(?:after|from|following)\s+(.*)/},{mode:"before",regex:/(?:(?:starting)\s+)?(.*)\s+(?:before|until|preceeding)\s+(.*)/},{mode:"at",regex:/at\s+(.*)/}],g=RegExp("^\\s*P?\\s*(?:(\\d+(?:[\\.,]\\d+)?)Y)?\\s*(?:(\\d+(?:[\\.,]\\d+)?)M)?\\s*(?:(\\d+(?:[\\.,]\\d+)?)D)?\\s*T?\\s*(?:(\\d+(?:[\\.,]\\d+)?)H)?\\s*(?:(\\d+(?:[\\.,]\\d+)?)M)?\\s*(?:(\\d+(?:[\\.,]\\d+)?)S)?$","i"),p=/(\d+(?:[\\.,]\\d+)?)\s*(y(?:ear)?s?)?(mon(?:th)?s?)?(d(?:ay)?s?)?(h(?:our)?s?)?(min(?:ute)?s?)?(s(?:econd)?s)?(m(?:illi)?s(?:econds?)?)?/gi;return e.extend(h.prototype,{start:function(){if(!this.isStarted()&&!this.isStopped()){var i=this._private(t),n=(new Date).getTime();a.call(this),i.isStarted=!0,n>=this.getEndsAt()?i.isEnded=!0:n>=this.getBeginsAt()?d.call(this):i.startTimeout=setTimeout(e.bind(d,this),this.getBeginsAt()-(new Date).getTime())}return this},stop:function(){if(!this.isStopped()){var e=this._private(t);e.isStopped=!0,clearTimeout(e.startTimeout),clearTimeout(e.tickTimeout),clearTimeout(e.endTimeout)}return this},mute:function(){var e=this._private(t);return e.isMuted||(e.isMuted=!0,clearTimeout(e.tickTimeout),this.publish("muted",this)),this},unmute:function(){var i=this._private(t);return i.isMuted&&(i.isMuted=!1,this.getTicksEvery()&&i.isStarted&&!i.isStopped&&i.isBegun&&!i.isEnded&&(i.tickTimeout=setTimeout(e.bind(u,this),o.call(this)-(new Date).getTime())),this.publish("unmuted",this)),this},subscribe:function(e,i){var n=this._private(t).notifyChannels;return n[e]||(n[e]=[]),n[e].push(i),this},publish:function(i,n,r){var s=this,a=this._private(t).notifyChannels;return a[i]&&(e.isArray(n)||(n=[n]),e.each(a[i],function(e){try{e.apply(r,n)}catch(t){s.logger.error(t)}})),this},unsubscribe:function(e){var i,n=this._private(t).notifyChannels,r=e[0],s=e[1];if(n[r])for(i=0;n[r].length>i;i+=1)n[r][i]===s&&n[r].splice(i,1);return this},toJSON:function(){return{name:this.getName(),state:{is_started:this.isStarted(),is_stopped:this.isEnded(),is_begun:this.isBegun(),is_ended:this.isEnded(),is_muted:this.isMuted()},begins_at:this.getBeginsAt(),ends_at:this.getEndsAt(),ticks_every:this.getTicksEvery(),relative_to:this.getTicksRelativeTo(),sync_to:this.getSyncsTo(),named_times:this.getNamedTimes(),data:this.getData(),relative_duration:this.getRelativeDuration()}},toString:function(){return JSON.stringify(this.toJson(),null,2)},logger:{log:new i("log"),info:new i("info"),debug:new i("debug"),warn:new i("warn"),error:new i("error")},isStarted:function(){return this._private(t).isStarted},isStopped:function(){return this._private(t).isStopped},isMuted:function(){return this._private(t).isMuted},isBegun:function(){return this._private(t).isBegun},isEnded:function(){return this._private(t).isEnded},getName:function(){return this._private(t).name},getBeginsAt:function(i){i=e.extend({originalValue:!1},i);var n,r=this._private(t);return i.originalValue?r.beginsAt:this.isStarted()?r.normalizedBeginsAt:(n=e.clone(r.namedTimes),e.each(r.namedTimes,function(e,t){n[t]=s(e,n)}),s(r.beginsAt,n))},beginsAt:function(e){if(!e)throw new n.MissingParameter;if(this.isStarted())throw new n.ImmutableError;return this._private(t).beginsAt=e,this},getEndsAt:function(i){i=e.extend({originalValue:!1},i);var n,r=this._private(t);return i.originalValue?r.endsAt:this.isStarted()?r.normalizedEndsAt:(n=e.clone(r.namedTimes),e.each(r.namedTimes,function(e,t){n[t]=s(e,n)}),n.beginsAt=s(r.beginsAt,n),s(r.endsAt,n))},endsAt:function(e){if(!e)throw new n.MissingParameter;if(this.isStarted())throw new n.ImmutableError;return this._private(t).endsAt=e,this},getTicksEvery:function(i){i=e.extend({originalValue:!1},i);var n=this._private(t);return i.originalValue?n.ticksEvery:this.isStarted()?n.normalizedTicksEvery:r(n.ticksEvery)},ticksEvery:function(e){if(!e)throw new n.MissingParameter;if(this.isStarted())throw new n.ImmutableError;return this._private(t).ticksEvery=e,this},getTicksRelativeTo:function(i){i=e.extend({originalValue:!1},i);var n,r=this._private(t);return i.originalValue?r.ticksRelativeTo:this.isStarted()?r.normalizedTicksRelativeTo:(n=e.clone(r.namedTimes),e.each(r.namedTimes,function(e,t){n[t]=s(e,n)}),n.beginsAt=s(r.beginsAt,n),n.endsAt=s(r.endsAt,n),s(r.ticksRelativeTo,n))},ticksRelativeTo:function(e){if(!e)throw new n.MissingParameter;if(this.isStarted())throw new n.ImmutableError;return this._private(t).ticksRelativeTo=e,this},getSyncsTo:function(i){i=e.extend({originalValue:!1},i);var n=this._private(t);return i.originalValue?n.syncsTo:this.isStarted()?n.normalizedSyncsTo:r(n.syncsTo)},syncsTo:function(e){if(!e)throw new n.MissingParameter;if(this.isStarted())throw new n.ImmutableError;return this._private(t).syncsTo=e,this},getNamedTimes:function(i){i=e.extend({originalValue:!1,includeDefaults:!1},i);var n,r=this._private(t),a={};return i.originalValue?e.each(r.namedTimes,function(t,n){(i.includeDefaults||!e.contains(m,n))&&(a[n]=t)}):this.isStarted()?a=e.clone(r.normalizedNamedTimes):(n=e.extend({beginsAt:s(r.beginsAt,r.namedTimes)},r.namedTimes),n.endsAt=s(r.endsAt,n),e.each(r.namedTimes,function(t,r){(i.includeDefaults||!e.contains(m,r))&&(a[r]=s(t,n))})),a},extendNamedTimes:function(i){if(!i)throw new n.MissingParameter;if(this.isStarted())throw new n.ImmutableError;return e.extend(this._private(t).namedTimes,i),this},getData:function(){return this._private(t).data},setData:function(e){if(!e)throw new n.MissingParameter;if(this.isStarted())throw new n.ImmutableError;return this._private(t).data=e,this},getRelativeDuration:function(){return this.getTicksRelativeTo()-(new Date).getTime()},version:"0.3.0"}),h.prototype.toJson=h.prototype.toJSON,h.version="0.3.0",h}var r=this;"function"==typeof define&&define.amd?define("kairos_time_frame",["underscore","kairos_errors"],n):e.KairosTimeFrame=n("function"==typeof require&&require("underscore")||e._||_,"function"==typeof require&&require("./kairos_errors")||e.KairosErrors||KairosErrors)}("object"==typeof exports&&exports||this,Math.floor(1e7*Math.random()+1e7).toString(36)),function(e,t){function i(e){return function(t,i){if(r.console&&console[e])if(i=[].splice.call(arguments,1),0===i.length)console[e](t);else try{console[e].apply(null,[].splice.call(arguments,0))}catch(n){console[e](t,i)}}}function n(e,n,r){function s(e){var t=this;e.subscribe("began",function(e){t.publish("timeFrameBegan",[e]),e.getName()&&t.publish(e.getName()+"/began",[e])}),e.subscribe("ended",function(e){t.publish("timeFrameEnded",[e]),e.getName()&&t.publish(e.getName()+"/ended",[e])}),e.subscribe("ticked",function(e){t.publish("timeFrameTicked",[e]),e.getName()&&t.publish(e.getName()+"/ticked",[e])}),e.subscribe("muted",function(e){t.publish("timeFrameMuted",[e]),e.getName()&&t.publish(e.getName()+"/muted",[e])}),e.subscribe("unmuted",function(e){t.publish("timeFrameUnmuted",[e]),e.getName()&&t.publish(e.getName()+"/unmuted",[e])})}function a(i){this.logger.info("Creating a new Kairos Collection");var a={frames:e.map(i,function(e){return e instanceof n?e:new n(e)}),notifyChannels:{}},o=e.compact(e.invoke(a.frames,"getName"));if(o.length!==e.unique(o).length)throw new r.DuplicateError("Duplicate names found");e.each(a.frames,e.bind(s,this)),this._private=function(e){if(e===t)return a;throw new r.AccessDenied}}return e.extend(a.prototype,{start:function(){return e.invoke(this._private(t).frames,"start"),this},stop:function(){return e.invoke(this._private(t).frames,"stop"),this},mute:function(){return e.invoke(this._private(t).frames,"mute"),this},unmute:function(){return e.invoke(this._private(t).frames,"unmute"),this},subscribe:function(e,i){var n=this._private(t).notifyChannels;return n[e]||(n[e]=[]),n[e].push(i),this},publish:function(i,n,r){var s=this,a=this._private(t).notifyChannels;return a[i]&&(e.isArray(n)||(n=[n]),e.each(a[i],function(e){try{e.apply(r,n)}catch(t){s.logger.error(t)}})),this},unsubscribe:function(e){var i,n=this._private(t).notifyChannels,r=e[0],s=e[1];if(n[r])for(i=0;n[r].length>i;i+=1)n[r][i]===s&&n[r].splice(i,1);return this},toJSON:function(){return{}},toString:function(){return JSON.stringify(this.toJson(),null,2)},logger:{log:new i("log"),info:new i("info"),debug:new i("debug"),warn:new i("warn"),error:new i("error")},extendNamedTimes:function(i){return e.invoke(this._private(t).frames,"extendNamedTimes",i),this},pushTimeFrame:function(e){return e instanceof n||(e=new n(e)),this.logger.info("Adding new Time Frame",e),this._private(t).frames.push(e),s.call(this,e),this},getTimeFrames:function(){return e.clone(this._private(t).frames)},getNamedTimeFrame:function(i){if(i)return e.find(this._private(t).frames,function(e){return e.getName()===i});throw new r.MissingParameter("No name was provided")},version:"0.3.0"}),a.prototype.toJson=a.prototype.toJSON,a.version="0.3.0",a}var r=this;"function"==typeof define&&define.amd?define("kairos_collection",["underscore","kairos_time_frame","kairos_errors"],n):e.KairosCollection=n("function"==typeof require&&require("underscore")||e._||_,"function"==typeof require&&require("./kairos_time_frame").KairosTimeFrame||e.KairosTimeFrame||KairosTimeFrame,"function"==typeof require&&require("./kairos_errors")||e.KairosErrors||KairosErrors)}("object"==typeof exports&&exports||this,Math.floor(1e7*Math.random()+1e7).toString(36));